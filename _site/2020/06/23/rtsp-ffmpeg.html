<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Working with RTSP in FFmpeg | Andrew Grathwohl</title><meta name="generator" content="Jekyll v4.1.0" /><meta property="og:title" content="Working with RTSP in FFmpeg" /><meta property="og:locale" content="en_US" /><meta name="description" content="Recently, I’ve found myself situated among a great fireworks battle in Brooklyn, NY. As we continue to work out the details about the heightened fireworks activity across the United States, I felt it was important that I document and share my experience to contribute what I can to the ongoing conversation. So, I grabbed an old IP camera I had in a corner gathering dust, placed it outside on my fire escape, and fired it up to get a decent shot of the night sky in my neighborhood." /><meta property="og:description" content="Recently, I’ve found myself situated among a great fireworks battle in Brooklyn, NY. As we continue to work out the details about the heightened fireworks activity across the United States, I felt it was important that I document and share my experience to contribute what I can to the ongoing conversation. So, I grabbed an old IP camera I had in a corner gathering dust, placed it outside on my fire escape, and fired it up to get a decent shot of the night sky in my neighborhood." /><link rel="canonical" href="https://grathwohl.me/2020/06/23/rtsp-ffmpeg" /><meta property="og:url" content="https://grathwohl.me/2020/06/23/rtsp-ffmpeg" /><meta property="og:site_name" content="Andrew Grathwohl" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-06-23T07:04:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Working with RTSP in FFmpeg" /><meta name="twitter:site" content="@andrewunmuted" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"https://grathwohl.me/2020/06/23/rtsp-ffmpeg","headline":"Working with RTSP in FFmpeg","dateModified":"2020-06-23T07:04:00-05:00","datePublished":"2020-06-23T07:04:00-05:00","description":"Recently, I’ve found myself situated among a great fireworks battle in Brooklyn, NY. As we continue to work out the details about the heightened fireworks activity across the United States, I felt it was important that I document and share my experience to contribute what I can to the ongoing conversation. So, I grabbed an old IP camera I had in a corner gathering dust, placed it outside on my fire escape, and fired it up to get a decent shot of the night sky in my neighborhood.","mainEntityOfPage":{"@type":"WebPage","@id":"https://grathwohl.me/2020/06/23/rtsp-ffmpeg"},"@context":"https://schema.org"}</script><link rel="shortcut icon" href="/favicon.png"><link rel="alternate" type="application/atom+xml" title="Andrew Grathwohl" href="/atom.xml"><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style type="text/css"> @font-face { font-family: 'EB Garamond'; font-style: normal; font-weight: 400; src: local('EB Garamond'), local('EBGaramond'), url(/font/EBGaramond-Regular.ttf) format('truetype'); } @font-face { font-family: 'Play'; font-style: normal; src: local('Play'), url(/font/Play-Regular.ttf) format('truetype'); } @font-face { font-family: 'Play'; font-style: bold; src: local('Play'), url(/font/Play-Bold.ttf) format('truetype'); } body{font-size:22px;line-height:1.5;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;-webkit-text-size-adjust:100%;zoom:1;font-family:"EB Garamond", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"}header p strong{text-transform:uppercase;font-family:"Play"}.post-title{background:black;margin:10rem 0;color:white;padding:2rem;font-family:"Play";font-weight:bold}h1,h2,h3,h4,h5,h6{font-family:"Play"}a,a:visited{color:black;font-weight:bold}a:hover,a:visited:hover{color:dodgerblue}a.active{background:black;padding:0.5rem;color:white;font-weight:bold}blockquote{background:#f9f9f9;border-left:5px solid black;font-size:120%;margin:2rem 0;padding:1rem}blockquote p{margin:0}blockquote footer{font-size:90%;margin:1rem 0 0 0}dl dt{margin-bottom:0.5rem}dl dd{font-style:italic;margin-bottom:2rem}code,pre{font-family:San Francisco Mono,Monaco,"Consolas","Lucida Console","DejaVu Sans Mono","Bitstream Vera Sans Mono",monospace;font-size:92%}pre{background:black;color:white;overflow:auto;padding:1em;width:100%}.date{opacity:0.6}html{box-sizing:border-box}*,*:before,*:after{box-sizing:inherit}body{margin:0 auto;max-width:50rem;padding:1rem}strong,b,h1,h2,h3,h4{font-weight:bold}hr{background:black;border:0;height:2px;margin:2rem 0;width:100%}table{border-collapse:collapse;text-align:left;width:100%}table tr{border-bottom:1px solid black}table td{padding:0.5rem}img{width:100%;margin:0.5rem 0}nav ul{list-style:none;padding:0;text-align:center}nav ul li{display:inline-block}nav a{margin:0.5rem;text-transform:uppercase}footer{margin:2rem 0}</style></head><body><header role="banner"><nav role="navigation"><ul><li><a href="/" >Index</a></li><li><a href="/notes.html" >Notes</a></li><li><a href="/about.html" >About</a></li><li><a href="/projects.html" >Projects</a></li></ul></nav></header><hr><main id="main" role="main"><article role="article"><h1>Working with RTSP in FFmpeg</h1><time class="date" datetime="2020-06-23T07:04:00-05:00">June 23, 2020</time><p>Recently, I’ve found myself situated among a <a href="https://news.yahoo.com/whats-sound-not-just-york-025006561.html?soc_src=hl-viewer&amp;soc_trk=tw">great fireworks battle</a> in Brooklyn, NY. As we continue to work out the details about the heightened fireworks activity across the United States, I felt it was important that I document and share my experience to contribute what I can to the ongoing conversation. So, I grabbed an old IP camera I had in a corner gathering dust, placed it outside on my fire escape, and fired it up to get a decent shot of the night sky in my neighborhood.</p><h2 id="ip-camera-trickiness">IP Camera Trickiness</h2><p><img src="/rtsp-control.jpg" alt="" /></p><p>I did a little snooping around the control pannel software on the camera to discover that the RTSP protocol is used to transport the signal over ethernet. Being an FFmpeg stan, I was confident that I would be able to quickly grab and relay my <a href="https://store.ui.com/collections/unifi-protect-cameras/products/unifi-video-camera-g3-dome">UVC-G3-DOME</a> signal right away. However, I failed to consider the contexts posed by the delivery transport. So, I was a bit surprised to discover that typing a typical <code class="language-plaintext highlighter-rouge">ffmpeg</code> test command to ingest this camera’s feed resulted in some really weird error logs and a very corrupt video output.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ffmpeg <span class="nt">-re</span> <span class="nt">-i</span> rtsp://192.168.3.55:554/s0 <span class="nt">-c</span>:v libx264 <span class="nt">-c</span>:a libmp3lame test.mkv
</code></pre></div></div><p><img src="/rtsp-corrupt.jpg" alt="" /></p><p>The above command would be adequate for testing the feed from software like <code class="language-plaintext highlighter-rouge">obs</code> and from services like AWS Kinesis or Wowza Cloud. But this RTSP signal looked all sorts of weird when saved to disk.</p><h2 id="how-to-rtsp-in-ffmpeg">How To RTSP in FFmpeg</h2><p>Upon doing some research, I discovered that <code class="language-plaintext highlighter-rouge">ffmpeg</code> has rich support for the <a href="http://ffmpeg.org/ffmpeg-all.html#rtsp">RTSP protocol</a>, but as a result there are some specific FFmpeg flags that must be utilized that I’d failed to include in my previous test command. <code class="language-plaintext highlighter-rouge">ffmpeg</code> requires the <code class="language-plaintext highlighter-rouge">-rtsp_transport</code> input flag to declare the transport used by the camera - TCP in my camera’s case. This new test command produced a most agreeable output.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ffmpeg <span class="nt">-re</span> <span class="nt">-rtsp_transport</span> tcp <span class="nt">-i</span> rtsp://192.168.3.55:554/s0 <span class="nt">-c</span>:v libx264 <span class="nt">-c</span>:a libmp3lame test.mkv
</code></pre></div></div><p><img src="/rtsp-clean.jpg" alt="" /></p><h3 id="rtmp-relaying">RTMP Relaying</h3><p>My ultimate use case is a common one - I wanted to be able to record the live feed to local disk as well as relay the stream to a YouTube live stream RTMP endpoint. To accomplish this, <code class="language-plaintext highlighter-rouge">ffmpeg</code> requires some specific output options declared to ensure compliance, as the direct RTSP signal from the camera is not in a compliant format.</p><p>To resolve the RTMP compliance issue, I declared <code class="language-plaintext highlighter-rouge">-f flv -ar 44100 -r 30/1 -pix_fmt yuv420p</code> as output options for the RTMP portion of my <code class="language-plaintext highlighter-rouge">ffmpeg</code> command. Declaring the format as FLV ensures the output bytestream is ordered in a way that is compliant with YouTube’s RTMP endpoint. Setting an explicit 44.1kHz sampling frequency for our audio guarantees full-spectrum audio while lowering overall output bitrate. And finally, enforcing the YUV420P pixel format ensures that your camera’s colors are correctly transformed to match YouTube’s color space.</p><p>The full command now looks like this:</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ffmpeg <span class="nt">-re</span> <span class="nt">-rtsp_transport</span> tcp <span class="nt">-i</span> rtsp://192.168.3.55:554/s0 <span class="nt">-c</span>:v copy <span class="se">\</span>
<span class="nt">-c</span>:a copy stream_capture.mkv <span class="nt">-c</span>:v libx264 <span class="nt">-b</span>:v 3M <span class="nt">-minrate</span>:v 3M <span class="nt">-maxrate</span>:v 3M <span class="se">\</span>
<span class="nt">-bufsize</span>:v 6M <span class="nt">-g</span> 120 <span class="nt">-r</span> 30/1 <span class="nt">-x264-params</span> <span class="nv">keyint</span><span class="o">=</span>120:min-keyint<span class="o">=</span>60 <span class="se">\</span>
<span class="nt">-c</span>:a libmp3lame <span class="nt">-ar</span> 44100 <span class="nt">-pix_fmt</span> yuv420p rtmp://YOUTUBE_RTMP_URL
</code></pre></div></div><p><img src="/fireworks.gif" alt="" /></p><p>That’s definitely a firework exploding a few feet away from my apartment building! Nice.</p></article></main><hr><footer class="footer" role="contentinfo"> <small> © 2020 Andrew Grathwohl / <a href="/atom.xml">RSS Feed</a>. </small></footer></body></html>
